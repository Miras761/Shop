<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞—Ä–∫–µ—Ç–ü–ª–µ–π—Å ‚Äî –û–±—ä—è–≤–ª–µ–Ω–∏—è</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõçÔ∏è</text></svg>">
    <style>
        /* ===== RESET & BASE ===== */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --primary: #002f34;
            --primary-light: #004d56;
            --accent: #23e5db;
            --accent2: #ffcc00;
            --danger: #e53e3e;
            --success: #38a169;
            --bg: #f5f5f5;
            --card: #ffffff;
            --border: #e0e0e0;
            --text: #1a1a1a;
            --text-muted: #717171;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            --radius: 10px;
            --radius-sm: 6px;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        a { color: inherit; text-decoration: none; }
        button { cursor: pointer; border: none; background: none; font: inherit; }
        input, textarea, select {
            font: inherit;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 10px 14px;
            outline: none;
            transition: border-color .2s;
            background: #fff;
        }
        input:focus, textarea:focus, select:focus { border-color: var(--accent); }

        /* ===== HEADER ===== */
        .header {
            background: var(--primary);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 12px rgba(0,0,0,0.2);
        }
        .header-inner {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            height: 64px;
        }
        .logo {
            font-size: 22px;
            font-weight: 800;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            cursor: pointer;
        }
        .logo span { color: var(--accent); }
        .search-bar {
            flex: 1;
            display: flex;
            max-width: 600px;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
        }
        .search-bar input {
            flex: 1;
            border: none;
            padding: 10px 16px;
            font-size: 15px;
            border-radius: 0;
        }
        .search-bar button {
            background: var(--accent);
            color: var(--primary);
            padding: 0 20px;
            font-weight: 700;
            font-size: 14px;
            transition: background .2s;
        }
        .search-bar button:hover { background: #1cc8bf; }
        .header-actions { display: flex; align-items: center; gap: 10px; margin-left: auto; }
        .btn { 
            display: inline-flex; align-items: center; gap: 6px;
            padding: 9px 18px; border-radius: 8px; font-weight: 600;
            font-size: 14px; transition: all .2s; cursor: pointer;
        }
        .btn-primary { background: var(--accent); color: var(--primary); }
        .btn-primary:hover { background: #1cc8bf; transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 1.5px solid rgba(255,255,255,0.4); color: #fff; }
        .btn-outline:hover { background: rgba(255,255,255,0.1); }
        .btn-post { background: var(--accent2); color: var(--primary); font-weight: 700; }
        .btn-post:hover { background: #e6b800; transform: translateY(-1px); }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-danger:hover { background: #c53030; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }

        /* ===== LAYOUT ===== */
        .container { max-width: 1280px; margin: 0 auto; padding: 0 20px; }
        .page { padding: 24px 0 48px; }

        /* ===== CATEGORIES NAV ===== */
        .cats-nav {
            background: var(--card);
            border-bottom: 1px solid var(--border);
        }
        .cats-inner {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            gap: 4px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .cats-inner::-webkit-scrollbar { display: none; }
        .cat-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            white-space: nowrap;
            transition: all .2s;
            cursor: pointer;
            min-width: 70px;
        }
        .cat-btn:hover, .cat-btn.active { color: var(--primary); background: #f0f9fa; }
        .cat-btn.active { color: var(--primary); font-weight: 700; border-bottom: 2px solid var(--accent); border-radius: 0; }
        .cat-emoji { font-size: 22px; }

        /* ===== HERO ===== */
        .hero {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 48px 20px;
            text-align: center;
        }
        .hero h1 { color: #fff; font-size: 36px; font-weight: 800; margin-bottom: 8px; }
        .hero p { color: rgba(255,255,255,0.75); font-size: 17px; margin-bottom: 28px; }
        .hero-search {
            max-width: 640px;
            margin: 0 auto;
            display: flex;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }
        .hero-search input {
            flex: 1;
            border: none;
            padding: 16px 20px;
            font-size: 16px;
            border-radius: 0;
        }
        .hero-search button {
            background: var(--accent2);
            color: var(--primary);
            padding: 0 28px;
            font-weight: 700;
            font-size: 16px;
            transition: background .2s;
        }
        .hero-search button:hover { background: #e6b800; }

        /* ===== FILTERS ===== */
        .filters-bar {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px 20px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
        .filter-group { display: flex; flex-direction: column; gap: 4px; }
        .filter-group label { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: .05em; }
        .filter-group select, .filter-group input { min-width: 140px; font-size: 13px; padding: 8px 12px; }
        .price-range { display: flex; align-items: center; gap: 6px; }
        .price-range input { width: 100px; }
        .price-range span { color: var(--text-muted); font-size: 13px; }

        /* ===== GRID ===== */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .section-title { font-size: 20px; font-weight: 700; }
        .listings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }

        /* ===== CARD ===== */
        .card {
            background: var(--card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all .2s;
            cursor: pointer;
            position: relative;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            border-color: transparent;
        }
        .card-img {
            width: 100%;
            aspect-ratio: 4/3;
            object-fit: cover;
            background: #e8e8e8;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: #ccc;
        }
        .card-img img { width: 100%; height: 100%; object-fit: cover; }
        .card-body { padding: 12px; }
        .card-price {
            font-size: 18px;
            font-weight: 800;
            color: var(--primary);
        }
        .card-price.negotiable::after {
            content: ' ¬∑ –¢–æ—Ä–≥';
            font-size: 12px;
            font-weight: 500;
            color: var(--success);
        }
        .card-title {
            font-size: 14px;
            color: var(--text);
            margin: 4px 0;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .card-meta {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }
        .badge-condition {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0,0,0,0.65);
            color: #fff;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .fav-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 17px;
            transition: all .2s;
            backdrop-filter: blur(4px);
        }
        .fav-btn:hover { transform: scale(1.15); }
        .fav-btn.active { background: #fff0f0; }

        /* ===== LISTING DETAIL ===== */
        .detail-layout {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 24px;
        }
        .gallery {
            border-radius: var(--radius);
            overflow: hidden;
            background: var(--card);
            border: 1px solid var(--border);
        }
        .gallery-main {
            width: 100%;
            aspect-ratio: 4/3;
            object-fit: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            font-size: 80px;
        }
        .gallery-main img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-thumbs {
            display: flex;
            gap: 8px;
            padding: 12px;
            overflow-x: auto;
        }
        .gallery-thumb {
            width: 72px;
            height: 54px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            flex-shrink: 0;
            transition: border-color .2s;
        }
        .gallery-thumb.active { border-color: var(--accent); }
        .detail-title { font-size: 24px; font-weight: 800; margin-bottom: 8px; }
        .detail-price { font-size: 30px; font-weight: 900; color: var(--primary); }
        .detail-badges { display: flex; gap: 8px; flex-wrap: wrap; margin: 12px 0; }
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-green { background: #e6f9f0; color: var(--success); }
        .badge-blue { background: #e6f0ff; color: #3366cc; }
        .badge-orange { background: #fff3e0; color: #e65100; }
        .detail-desc {
            font-size: 15px;
            line-height: 1.7;
            color: #333;
            margin: 16px 0;
            white-space: pre-wrap;
        }
        .detail-info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }
        .detail-info-row:last-child { border-bottom: none; }
        .detail-info-row .label { color: var(--text-muted); }
        .seller-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            position: sticky;
            top: 80px;
        }
        .seller-header { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; }
        .seller-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: var(--primary);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 700;
            flex-shrink: 0;
            overflow: hidden;
        }
        .seller-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .seller-name { font-weight: 700; font-size: 16px; }
        .seller-since { font-size: 12px; color: var(--text-muted); }
        .seller-rating { display: flex; align-items: center; gap: 4px; font-size: 13px; margin-top: 2px; }
        .stars { color: var(--accent2); }
        .contact-actions { display: flex; flex-direction: column; gap: 10px; }
        .btn-contact { width: 100%; padding: 14px; font-size: 16px; font-weight: 700; border-radius: 8px; }
        .phone-reveal {
            background: var(--primary);
            color: #fff;
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 800;
            letter-spacing: 1px;
        }

        /* ===== MODAL ===== */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.55);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            backdrop-filter: blur(3px);
        }
        .modal {
            background: var(--card);
            border-radius: 16px;
            padding: 32px;
            width: 100%;
            max-width: 440px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 22px;
            color: var(--text-muted);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background .2s;
        }
        .modal-close:hover { background: var(--bg); }
        .modal h2 { font-size: 22px; font-weight: 800; margin-bottom: 24px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--text-muted); }
        .form-group input, .form-group textarea, .form-group select { width: 100%; }
        .form-group textarea { height: 100px; resize: vertical; }
        .form-divider { text-align: center; color: var(--text-muted); font-size: 13px; margin: 12px 0; }
        .social-btn { width: 100%; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600; margin-bottom: 8px; border: 1.5px solid var(--border); }
        .tab-btns { display: flex; border-bottom: 2px solid var(--border); margin-bottom: 24px; }
        .tab-btn { flex: 1; padding: 10px; text-align: center; font-weight: 600; font-size: 14px; color: var(--text-muted); cursor: pointer; }
        .tab-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); margin-bottom: -2px; }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-muted);
        }
        .empty-state .emoji { font-size: 64px; margin-bottom: 16px; }
        .empty-state h3 { font-size: 20px; font-weight: 700; color: var(--text); margin-bottom: 8px; }

        /* ===== POST FORM ===== */
        .post-form {
            max-width: 720px;
            margin: 0 auto;
            background: var(--card);
            border-radius: var(--radius);
            padding: 32px;
            border: 1px solid var(--border);
        }
        .post-form h1 { font-size: 24px; font-weight: 800; margin-bottom: 24px; }
        .image-upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all .2s;
            background: var(--bg);
        }
        .image-upload-area:hover { border-color: var(--accent); background: #f0fcfb; }
        .image-upload-area input { display: none; }
        .img-previews { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
        .img-preview { width: 90px; height: 70px; border-radius: 6px; object-fit: cover; }

        /* ===== TOAST ===== */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .toast {
            background: var(--primary);
            color: #fff;
            padding: 14px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            animation: slideIn .3s ease;
            max-width: 320px;
        }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ===== PAGINATION ===== */
        .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 32px; }
        .page-btn {
            width: 36px; height: 36px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 600; font-size: 14px;
            border: 1.5px solid var(--border);
            background: var(--card);
            cursor: pointer;
            transition: all .2s;
        }
        .page-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .page-btn:hover:not(.active) { background: var(--bg); }

        /* ===== PROFILE PAGE ===== */
        .profile-header {
            background: var(--primary);
            padding: 40px 0;
            color: #fff;
        }
        .profile-info { display: flex; align-items: center; gap: 20px; }
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 800;
            color: var(--primary);
            overflow: hidden;
            flex-shrink: 0;
        }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .profile-name { font-size: 24px; font-weight: 800; }
        .profile-stats { display: flex; gap: 24px; margin-top: 8px; }
        .profile-stat { font-size: 14px; opacity: .8; }
        .profile-stat strong { opacity: 1; font-weight: 700; }

        /* ===== TABS ===== */
        .page-tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 24px;
            gap: 0;
        }
        .page-tab {
            padding: 12px 20px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all .2s;
        }
        .page-tab.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* ===== SKELETON ===== */
        .skeleton {
            background: linear-gradient(90deg, #e8e8e8 25%, #f0f0f0 50%, #e8e8e8 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 6px;
        }
        @keyframes shimmer {
            from { background-position: 200% 0; }
            to { background-position: -200% 0; }
        }
        .skeleton-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .header-inner { gap: 10px; height: 56px; }
            .search-bar { display: none; }
            .detail-layout { grid-template-columns: 1fr; }
            .listings-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .hero { padding: 32px 16px; }
            .hero h1 { font-size: 26px; }
            .cats-inner { gap: 0; }
            .post-form { padding: 20px 16px; }
        }
        @media (max-width: 480px) {
            .listings-grid { grid-template-columns: 1fr; }
            .modal { padding: 24px 16px; }
        }

        /* ===== CHAT ===== */
        .chat-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            height: calc(100vh - 130px);
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }
        .dialogs-sidebar {
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .dialogs-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            font-weight: 700;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg);
        }
        .dialogs-list { overflow-y: auto; flex: 1; }
        .dialog-item {
            display: flex;
            gap: 12px;
            padding: 14px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background .15s;
        }
        .dialog-item:hover { background: var(--bg); }
        .dialog-item.active { background: #e8f8f7; border-left: 3px solid var(--accent); }
        .dialog-avatar {
            width: 46px; height: 46px; border-radius: 50%;
            background: var(--primary); color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: 700; flex-shrink: 0; overflow: hidden;
        }
        .dialog-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .dialog-info { flex: 1; min-width: 0; }
        .dialog-name { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .dialog-last { font-size: 12px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
        .dialog-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0; }
        .dialog-time { font-size: 11px; color: var(--text-muted); }
        .unread-badge {
            background: var(--accent); color: var(--primary);
            border-radius: 20px; padding: 2px 7px; font-size: 11px;
            font-weight: 800; min-width: 20px; text-align: center;
        }
        .chat-window { display: flex; flex-direction: column; overflow: hidden; }
        .chat-header {
            padding: 14px 20px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 12px; background: var(--bg);
        }
        .chat-user-name { font-weight: 700; font-size: 15px; }
        .chat-user-sub { font-size: 12px; color: var(--text-muted); }
        .chat-messages {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 10px; background: #f8fffe;
        }
        .msg-row { display: flex; gap: 8px; max-width: 75%; }
        .msg-row.mine { align-self: flex-end; flex-direction: row-reverse; }
        .msg-row.theirs { align-self: flex-start; }
        .msg-avatar {
            width: 32px; height: 32px; border-radius: 50%;
            background: var(--primary); color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 700; flex-shrink: 0;
            overflow: hidden; align-self: flex-end;
        }
        .msg-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .msg-bubble {
            padding: 10px 14px; border-radius: 18px;
            font-size: 14px; line-height: 1.5; word-break: break-word;
        }
        .msg-row.mine .msg-bubble { background: var(--primary); color: #fff; border-bottom-right-radius: 4px; }
        .msg-row.theirs .msg-bubble { background: #fff; border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        .msg-time { font-size: 10px; opacity: .6; margin-top: 4px; text-align: right; }
        .msg-image { max-width: 220px; border-radius: 12px; cursor: pointer; display: block; margin-top: 4px; }
        .msg-date-divider {
            text-align: center; font-size: 11px; color: var(--text-muted); margin: 8px 0;
            align-self: center; background: var(--border); padding: 2px 12px; border-radius: 20px;
        }
        .chat-input-area {
            padding: 12px 16px; border-top: 1px solid var(--border);
            background: #fff; display: flex; gap: 10px; align-items: flex-end;
        }
        .chat-input-wrap { flex: 1; position: relative; }
        .chat-input {
            width: 100%; border: 1.5px solid var(--border); border-radius: 22px;
            padding: 10px 48px 10px 16px; font-size: 14px; resize: none;
            max-height: 120px; min-height: 44px; overflow-y: auto;
        }
        .chat-attach-btn {
            position: absolute; right: 12px; bottom: 10px;
            font-size: 18px; color: var(--text-muted); cursor: pointer;
        }
        .chat-attach-btn:hover { color: var(--primary); }
        .chat-send-btn {
            width: 44px; height: 44px; border-radius: 50%;
            background: var(--primary); color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; flex-shrink: 0; transition: all .2s;
        }
        .chat-send-btn:hover { background: var(--primary-light); transform: scale(1.05); }
        .chat-empty {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; color: var(--text-muted); gap: 12px;
        }
        .img-preview-strip {
            display: flex; gap: 6px; padding: 8px 16px;
            background: #f0f9f8; border-top: 1px solid var(--border);
        }
        .img-preview-chip { position: relative; display: inline-block; }
        .img-preview-chip img { width: 60px; height: 50px; object-fit: cover; border-radius: 8px; }
        .img-preview-chip .remove-img {
            position: absolute; top: -4px; right: -4px;
            background: var(--danger); color: #fff; border-radius: 50%;
            width: 18px; height: 18px; font-size: 10px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .notif-bell { position: relative; color: #fff; font-size: 20px; cursor: pointer; padding: 4px; }
        .notif-dot {
            position: absolute; top: 0; right: 0;
            background: var(--danger); color: #fff; border-radius: 50%;
            width: 18px; height: 18px; font-size: 10px; font-weight: 800;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--primary);
        }
        .notif-dropdown {
            position: absolute; top: 60px; right: 0; width: 340px;
            background: var(--card); border: 1px solid var(--border);
            border-radius: var(--radius); box-shadow: var(--shadow-lg);
            z-index: 150; max-height: 420px; overflow-y: auto;
        }
        .notif-header {
            padding: 14px 16px; font-weight: 700;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .notif-item {
            padding: 12px 16px; border-bottom: 1px solid var(--border);
            font-size: 13px; cursor: pointer; transition: background .15s;
        }
        .notif-item:hover { background: var(--bg); }
        .notif-item.unread { background: #f0fffe; border-left: 3px solid var(--accent); }
        .notif-text { font-weight: 500; margin-bottom: 2px; }
        .notif-time { font-size: 11px; color: var(--text-muted); }
        @media (max-width: 768px) {
            .chat-layout { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- HEADER -->
<header class="header">
    <div class="header-inner">
        <div class="logo" onclick="navigate('home')">üõçÔ∏è –ú–∞—Ä–∫<span>–µ—Ç</span></div>
        <div class="search-bar">
            <input type="text" id="header-search" placeholder="–ü–æ–∏—Å–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π..." onkeypress="if(event.key==='Enter')doSearch()">
            <button onclick="doSearch()">–ù–∞–π—Ç–∏</button>
        </div>
        <div class="header-actions" id="header-actions"></div>
    </div>
</header>

<!-- CATEGORIES NAV -->
<nav class="cats-nav" id="cats-nav" style="display:none">
    <div class="cats-inner" id="cats-inner"></div>
</nav>

<!-- MAIN CONTENT -->
<main id="app"></main>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toasts"></div>

<script>
// ==========================================
// STATE & CONFIG
// ==========================================
const API = '/api';
let state = {
    user: null,
    token: localStorage.getItem('token'),
    page: 'home',
    listings: [],
    categories: [],
    currentListing: null,
    filters: { search: '', category: '', min_price: '', max_price: '', condition: '' },
    pagination: { count: 0, next: null, previous: null, current: 1 },
    activeCategory: null,
    // Chat
    dialogs: [],
    activeDialog: null,
    chatMessages: [],
    unreadCount: 0,
    chatImages: [],  // pending images to send
};

// ==========================================
// UTILITIES
// ==========================================
const $ = id => document.getElementById(id);
const app = () => $('app');

function formatPrice(price) {
    return new Intl.NumberFormat('ru-RU').format(price) + ' ‚ÇΩ';
}

function timeAgo(dateStr) {
    const diff = Date.now() - new Date(dateStr);
    const m = Math.floor(diff / 60000);
    if (m < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if (m < 60) return `${m} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
    const h = Math.floor(m / 60);
    if (h < 24) return `${h} —á. –Ω–∞–∑–∞–¥`;
    const d = Math.floor(h / 24);
    if (d < 30) return `${d} –¥–Ω. –Ω–∞–∑–∞–¥`;
    return new Date(dateStr).toLocaleDateString('ru-RU');
}

function getInitials(name) {
    return name ? name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2) : '?';
}

function toast(msg, type = 'info') {
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.textContent = msg;
    $('toasts').appendChild(el);
    setTimeout(() => el.remove(), 3500);
}

async function api(path, opts = {}) {
    const headers = { 'Content-Type': 'application/json' };
    if (state.token) headers['Authorization'] = `Token ${state.token}`;
    if (opts.body instanceof FormData) delete headers['Content-Type'];
    const res = await fetch(API + path, {
        ...opts,
        headers: { ...headers, ...(opts.headers || {}) },
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw data;
    return data;
}

function navigate(page, params = {}) {
    state.page = page;
    state.pageParams = params;
    render();
    window.scrollTo(0, 0);
}

// ==========================================
// AUTH
// ==========================================
async function checkAuth() {
    if (!state.token) return;
    try {
        state.user = await api('/auth/profile/');
    } catch {
        state.token = null;
        localStorage.removeItem('token');
    }
}

function showAuthModal(tab = 'login') {
    renderModal(`
        <div class="tab-btns">
            <div class="tab-btn ${tab === 'login' ? 'active' : ''}" onclick="showAuthModal('login')">–í–æ–π—Ç–∏</div>
            <div class="tab-btn ${tab === 'register' ? 'active' : ''}" onclick="showAuthModal('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
        </div>
        ${tab === 'login' ? loginForm() : registerForm()}
    `);
}

function loginForm() {
    return `
        <div class="form-group"><label>–õ–æ–≥–∏–Ω</label><input id="a-username" placeholder="–í–∞—à –ª–æ–≥–∏–Ω"></div>
        <div class="form-group"><label>–ü–∞—Ä–æ–ª—å</label><input id="a-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" onkeypress="if(event.key==='Enter')doLogin()"></div>
        <button class="btn btn-primary" style="width:100%;padding:13px;font-size:16px;margin-top:8px" onclick="doLogin()">–í–æ–π—Ç–∏</button>
        <p style="text-align:center;margin-top:16px;font-size:13px;color:var(--text-muted)">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" onclick="showAuthModal('register')" style="color:var(--primary);font-weight:600">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
    `;
}

function registerForm() {
    return `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div class="form-group"><label>–ò–º—è</label><input id="r-first" placeholder="–ò–º—è"></div>
            <div class="form-group"><label>–§–∞–º–∏–ª–∏—è</label><input id="r-last" placeholder="–§–∞–º–∏–ª–∏—è"></div>
        </div>
        <div class="form-group"><label>–õ–æ–≥–∏–Ω *</label><input id="r-username" placeholder="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –ª–æ–≥–∏–Ω"></div>
        <div class="form-group"><label>Email *</label><input id="r-email" type="email" placeholder="email@example.com"></div>
        <div class="form-group"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="r-phone" placeholder="+7 (999) 999-99-99"></div>
        <div class="form-group"><label>–ì–æ—Ä–æ–¥</label><input id="r-city" placeholder="–í–∞—à –≥–æ—Ä–æ–¥"></div>
        <div class="form-group"><label>–ü–∞—Ä–æ–ª—å *</label><input id="r-pass" type="password" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤"></div>
        <div class="form-group"><label>–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å *</label><input id="r-pass2" type="password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"></div>
        <button class="btn btn-primary" style="width:100%;padding:13px;font-size:16px;margin-top:8px" onclick="doRegister()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
    `;
}

async function doLogin() {
    try {
        const data = await api('/auth/login/', {
            method: 'POST',
            body: JSON.stringify({
                username: $('a-username').value,
                password: $('a-password').value,
            }),
        });
        state.token = data.token;
        state.user = data.user;
        localStorage.setItem('token', data.token);
        closeModal();
        toast('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ' + data.user.first_name || data.user.username + '!', 'success');
        renderHeader();
    } catch (e) {
        toast(e.non_field_errors?.[0] || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞', 'error');
    }
}

async function doRegister() {
    try {
        const data = await api('/auth/register/', {
            method: 'POST',
            body: JSON.stringify({
                username: $('r-username').value,
                email: $('r-email').value,
                password: $('r-pass').value,
                password2: $('r-pass2').value,
                first_name: $('r-first').value,
                last_name: $('r-last').value,
                phone: $('r-phone').value,
                city: $('r-city').value,
            }),
        });
        state.token = data.token;
        state.user = data.user;
        localStorage.setItem('token', data.token);
        closeModal();
        toast('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω!', 'success');
        renderHeader();
    } catch (e) {
        const msg = Object.values(e)[0]?.[0] || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
        toast(msg, 'error');
    }
}

async function doLogout() {
    try { await api('/auth/logout/', { method: 'POST' }); } catch {}
    state.token = null;
    state.user = null;
    localStorage.removeItem('token');
    toast('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
    renderHeader();
    navigate('home');
}

// ==========================================
// CATEGORIES
// ==========================================
async function loadCategories() {
    try {
        const data = await api('/categories/');
        // API –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –º–∞—Å—Å–∏–≤ –∏–ª–∏ {results: [...]}
        state.categories = Array.isArray(data) ? data : (data.results || []);
        renderCatsNav();
    } catch {}
}

function renderCatsNav() {
    const nav = $('cats-nav');
    const inner = $('cats-inner');
    nav.style.display = 'block';
    inner.innerHTML = `
        <div class="cat-btn ${!state.activeCategory ? 'active' : ''}" onclick="filterByCategory(null)">
            <span class="cat-emoji">üè†</span>
            <span>–í—Å–µ</span>
        </div>
        ${state.categories.map(c => `
            <div class="cat-btn ${state.activeCategory === c.id ? 'active' : ''}" onclick="filterByCategory(${c.id})">
                <span class="cat-emoji">${c.icon || 'üì¶'}</span>
                <span>${c.name}</span>
            </div>
        `).join('')}
    `;
}

function filterByCategory(id) {
    state.activeCategory = id;
    state.filters.category = id || '';
    state.pagination.current = 1;
    renderCatsNav();
    if (state.page !== 'home') navigate('home');
    else loadListings();
}

// ==========================================
// LISTINGS
// ==========================================
async function loadListings(page = 1) {
    const f = state.filters;
    const params = new URLSearchParams({
        page,
        ...(f.search && { search: f.search }),
        ...(f.category && { category: f.category }),
        ...(f.min_price && { min_price: f.min_price }),
        ...(f.max_price && { max_price: f.max_price }),
        ...(f.condition && { condition: f.condition }),
        ...(f.ordering && { ordering: f.ordering }),
    });
    try {
        const data = await api('/listings/?' + params);
        state.listings = data.results;
        state.pagination = {
            count: data.count,
            next: data.next,
            previous: data.previous,
            current: page,
        };
        if (state.page === 'home') renderHome();
        return data;
    } catch { toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π', 'error'); }
}

async function loadListing(id) {
    try {
        const data = await api(`/listings/${id}/`);
        state.currentListing = data;
        renderDetail();
    } catch { toast('–û–±—ä—è–≤–ª–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error'); }
}

async function toggleFavorite(id, e) {
    e && e.stopPropagation();
    if (!state.user) { showAuthModal(); return; }
    try {
        const r = await api(`/listings/${id}/favorite/`, { method: 'POST' });
        toast(r.status === 'added' ? '‚ù§Ô∏è –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' : 'ü§ç –£–±—Ä–∞–Ω–æ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ');
        loadListings(state.pagination.current);
    } catch { toast('–û—à–∏–±–∫–∞', 'error'); }
}

function doSearch() {
    const q = $('header-search')?.value || '';
    state.filters.search = q;
    state.pagination.current = 1;
    navigate('home');
    loadListings();
}

// ==========================================
// RENDER HEADER
// ==========================================
function renderHeader() {
    const el = $('header-actions');
    if (state.user) {
        const unread = state.unreadCount;
        el.innerHTML = `
            <button class="btn btn-post" onclick="navigate('post')">+ –ü–æ–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</button>
            <div class="notif-bell" onclick="toggleNotifDropdown()" title="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" id="notif-bell">
                üîî
                ${unread > 0 ? `<div class="notif-dot">${unread > 9 ? '9+' : unread}</div>` : ''}
            </div>
            <button class="btn btn-outline" onclick="navigate('chat')" title="–ß–∞—Ç" style="position:relative">
                üí¨
                ${state.unreadMessages > 0 ? `<span style="position:absolute;top:-4px;right:-4px;background:var(--danger);color:#fff;border-radius:50%;width:16px;height:16px;font-size:9px;font-weight:800;display:flex;align-items:center;justify-content:center">${state.unreadMessages}</span>` : ''}
            </button>
            <button class="btn btn-outline" onclick="navigate('profile')" title="–ü—Ä–æ—Ñ–∏–ª—å">
                <div style="width:28px;height:28px;border-radius:50%;background:var(--accent);color:var(--primary);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;flex-shrink:0">
                    ${getInitials(state.user.first_name + ' ' + state.user.last_name)}
                </div>
                <span>${state.user.username}</span>
            </button>
        `;
    } else {
        el.innerHTML = `
            <button class="btn btn-outline" onclick="showAuthModal('login')">–í–æ–π—Ç–∏</button>
            <button class="btn btn-post" onclick="navigate('post')">+ –ü–æ–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</button>
        `;
    }
}

// ==========================================
// RENDER PAGES
// ==========================================
function render() {
    switch (state.page) {
        case 'home': renderHome(); break;
        case 'detail': renderDetail(); break;
        case 'post': renderPostForm(); break;
        case 'profile': renderProfile(); break;
        case 'chat': renderChat(); break;
        default: renderHome();
    }
}

// HOME PAGE
function renderHome() {
    const { listings, pagination } = state;
    const totalPages = Math.ceil(pagination.count / 20);

    app().innerHTML = `
        ${!state.activeCategory && !state.filters.search ? `
        <div class="hero">
            <h1>–í—Å—ë ‚Äî —Ä—è–¥–æ–º —Å –≤–∞–º–∏</h1>
            <p>–ú–∏–ª–ª–∏–æ–Ω—ã –æ–±—ä—è–≤–ª–µ–Ω–∏–π –ø–æ –≤—Å–µ–π –†–æ—Å—Å–∏–∏</p>
            <div class="hero-search">
                <input type="text" placeholder="–ò—â–∏—Ç–µ —á—Ç–æ —É–≥–æ–¥–Ω–æ..." id="hero-q" value="${state.filters.search}" onkeypress="if(event.key==='Enter'){state.filters.search=this.value;loadListings()}">
                <button onclick="state.filters.search=$('hero-q').value;loadListings()">üîç –ù–∞–π—Ç–∏</button>
            </div>
        </div>
        ` : ''}

        <div class="container page">
            <div class="filters-bar">
                <div class="filter-group">
                    <label>–°–æ—Å—Ç–æ—è–Ω–∏–µ</label>
                    <select onchange="state.filters.condition=this.value;loadListings()">
                        <option value="">–õ—é–±–æ–µ</option>
                        <option value="new" ${state.filters.condition==='new'?'selected':''}>–ù–æ–≤–æ–µ</option>
                        <option value="used" ${state.filters.condition==='used'?'selected':''}>–ë/–£</option>
                        <option value="damaged" ${state.filters.condition==='damaged'?'selected':''}>–¢—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>–¶–µ–Ω–∞</label>
                    <div class="price-range">
                        <input type="number" placeholder="–û—Ç" value="${state.filters.min_price}" onchange="state.filters.min_price=this.value;loadListings()" style="width:90px">
                        <span>‚Äî</span>
                        <input type="number" placeholder="–î–æ" value="${state.filters.max_price}" onchange="state.filters.max_price=this.value;loadListings()" style="width:90px">
                    </div>
                </div>
                <div class="filter-group">
                    <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                    <select onchange="state.filters.ordering=this.value;loadListings()">
                        <option value="-created_at">–ù–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞</option>
                        <option value="price">–î–µ—à–µ–≤–ª–µ —Å–Ω–∞—á–∞–ª–∞</option>
                        <option value="-price">–î–æ—Ä–æ–∂–µ —Å–Ω–∞—á–∞–ª–∞</option>
                        <option value="-views_count">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</option>
                    </select>
                </div>
                <div style="margin-left:auto;font-size:13px;color:var(--text-muted);align-self:flex-end">
                    –ù–∞–π–¥–µ–Ω–æ: <strong>${pagination.count}</strong>
                </div>
            </div>

            <div class="section-header">
                <h2 class="section-title">${state.filters.search ? `–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è ¬´${state.filters.search}¬ª` : state.activeCategory ? state.categories.find(c=>c.id===state.activeCategory)?.name || '–û–±—ä—è–≤–ª–µ–Ω–∏—è' : '–°–≤–µ–∂–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è'}</h2>
            </div>

            ${listings.length === 0 ? `
                <div class="empty-state">
                    <div class="emoji">üîç</div>
                    <h3>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                    <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
                </div>
            ` : `
                <div class="listings-grid">
                    ${listings.map(l => renderCard(l)).join('')}
                </div>
            `}

            ${totalPages > 1 ? `
                <div class="pagination">
                    ${Array.from({length: Math.min(totalPages, 7)}, (_, i) => i + 1).map(p => `
                        <button class="page-btn ${p === pagination.current ? 'active' : ''}" onclick="loadListings(${p})">${p}</button>
                    `).join('')}
                    ${totalPages > 7 ? `<span style="display:flex;align-items:center;color:var(--text-muted)">... ${totalPages}</span>` : ''}
                </div>
            ` : ''}
        </div>
    `;
}

function renderCard(l) {
    const condLabels = { new: '–ù–æ–≤–æ–µ', used: '–ë/–£', damaged: '–†–µ–º–æ–Ω—Ç' };
    return `
        <div class="card" onclick="navigate('detail');loadListing(${l.id})">
            <div class="card-img">
                ${l.main_image ? `<img src="${l.main_image}" alt="${l.title}" loading="lazy">` : 'üì¶'}
            </div>
            <span class="badge-condition">${condLabels[l.condition] || '–ë/–£'}</span>
            <button class="fav-btn ${l.is_favorite ? 'active' : ''}" onclick="toggleFavorite(${l.id}, event)" title="${l.is_favorite ? '–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}">
                ${l.is_favorite ? '‚ù§Ô∏è' : 'ü§ç'}
            </button>
            <div class="card-body">
                <div class="card-price ${l.is_negotiable ? 'negotiable' : ''}">${formatPrice(l.price)}</div>
                <div class="card-title">${l.title}</div>
                <div class="card-meta">
                    <span>üìç ${l.city || l.seller_city || '–†–æ—Å—Å–∏—è'}</span>
                    <span>${timeAgo(l.created_at)}</span>
                </div>
            </div>
        </div>
    `;
}

// DETAIL PAGE
function renderDetail() {
    const l = state.currentListing;
    if (!l) {
        app().innerHTML = `<div class="container page"><div class="empty-state"><div class="emoji">üîÑ</div><h3>–ó–∞–≥—Ä—É–∑–∫–∞...</h3></div></div>`;
        return;
    }

    const condLabels = { new: '–ù–æ–≤–æ–µ', used: '–ë/–£', damaged: '–¢—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞' };
    const imgs = l.images || [];

    app().innerHTML = `
        <div class="container page">
            <nav style="font-size:13px;color:var(--text-muted);margin-bottom:16px">
                <a href="#" onclick="navigate('home');loadListings()" style="color:var(--primary)">‚Üê –ù–∞–∑–∞–¥ –∫ –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º</a>
                ${l.category ? ` / ${l.category.name}` : ''}
            </nav>

            <div class="detail-layout">
                <div>
                    <!-- Gallery -->
                    <div class="gallery">
                        <div class="gallery-main" id="gallery-main">
                            ${imgs.length > 0
                                ? `<img id="main-img" src="${imgs[0].image_url}" alt="${l.title}">`
                                : 'üì¶'
                            }
                        </div>
                        ${imgs.length > 1 ? `
                        <div class="gallery-thumbs">
                            ${imgs.map((img, i) => `
                                <img class="gallery-thumb ${i === 0 ? 'active' : ''}" src="${img.image_url}"
                                     onclick="selectThumb(this,'${img.image_url}')">
                            `).join('')}
                        </div>
                        ` : ''}
                    </div>

                    <!-- Info -->
                    <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-top:20px">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px">
                            <div>
                                <div class="detail-price">${formatPrice(l.price)} ${l.is_negotiable ? '<span style="font-size:14px;color:var(--success);font-weight:600">¬∑ –¢–æ—Ä–≥</span>' : ''}</div>
                                <h1 class="detail-title">${l.title}</h1>
                            </div>
                            <button class="btn ${l.is_favorite ? 'btn-danger' : 'btn-outline'}" style="border-color:var(--border);color:var(--text)" onclick="toggleFavorite(${l.id})">
                                ${l.is_favorite ? '‚ù§Ô∏è –í –∏–∑–±—Ä–∞–Ω–Ω–æ–º' : 'ü§ç –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}
                            </button>
                        </div>

                        <div class="detail-badges">
                            <span class="badge badge-blue">${condLabels[l.condition] || '–ë/–£'}</span>
                            ${l.category ? `<span class="badge badge-green">${l.category.icon || ''} ${l.category.name}</span>` : ''}
                            ${l.city ? `<span class="badge" style="background:#f5f5f5">üìç ${l.city}</span>` : ''}
                        </div>

                        <h3 style="font-size:15px;font-weight:700;margin-bottom:8px">–û–ø–∏—Å–∞–Ω–∏–µ</h3>
                        <div class="detail-desc">${l.description}</div>

                        <div style="border-top:1px solid var(--border);margin-top:16px;padding-top:16px">
                            <div class="detail-info-row">
                                <span class="label">–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</span>
                                <span>üëÅ ${l.views_count}</span>
                            </div>
                            <div class="detail-info-row">
                                <span class="label">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</span>
                                <span>${new Date(l.created_at).toLocaleDateString('ru-RU', {day:'numeric',month:'long',year:'numeric'})}</span>
                            </div>
                            <div class="detail-info-row">
                                <span class="label">ID –æ–±—ä—è–≤–ª–µ–Ω–∏—è</span>
                                <span>#${l.id}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seller Sidebar -->
                <div>
                    <div class="seller-card">
                        <div class="seller-header">
                            <div class="seller-avatar">
                                ${l.seller?.avatar_url
                                    ? `<img src="${l.seller.avatar_url}" alt="${l.seller.username}">`
                                    : getInitials((l.seller?.first_name || '') + ' ' + (l.seller?.last_name || ''))
                                }
                            </div>
                            <div>
                                <div class="seller-name">${l.seller?.first_name || l.seller?.username || '–ü—Ä–æ–¥–∞–≤–µ—Ü'} ${l.seller?.last_name || ''}</div>
                                <div class="seller-since">–ù–∞ —Å–∞–π—Ç–µ —Å ${new Date(l.seller?.date_joined).toLocaleDateString('ru-RU', {month:'long',year:'numeric'})}</div>
                                <div class="seller-rating">
                                    <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                                    <span style="font-weight:700">${l.seller?.rating?.toFixed(1) || '5.0'}</span>
                                    <span style="color:var(--text-muted)">(${l.seller?.reviews_count || 0})</span>
                                </div>
                            </div>
                        </div>

                        <div class="contact-actions">
                            <button id="phone-btn" class="btn btn-primary btn-contact" onclick="revealPhone(${l.id})">
                                üìû –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω
                            </button>
                            <button class="btn btn-contact" style="background:var(--primary);color:#fff" onclick="startChatWithSeller(${l.seller.id}, ${l.id})">
                                üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥–∞–≤—Ü—É
                            </button>
                        </div>

                        <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                        <div style="font-size:13px;color:var(--text-muted);text-align:center">
                            ‚ö†Ô∏è –ü—Ä–æ–≤–æ–¥–∏—Ç–µ —Å–¥–µ–ª–∫–∏ –ª–∏—á–Ω–æ, –±—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã —Å –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–æ–π
                        </div>
                    </div>

                    ${l.seller ? `
                    <div style="margin-top:16px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px">
                        <div style="font-weight:700;margin-bottom:12px">–î—Ä—É–≥–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥–∞–≤—Ü–∞</div>
                        <button class="btn btn-primary btn-sm" onclick="navigate('home');state.filters={...state.filters,seller:${l.seller.id}};loadListings()">
                            –í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è ‚Üí
                        </button>
                    </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}

function selectThumb(el, url) {
    document.querySelectorAll('.gallery-thumb').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    $('main-img').src = url;
}

function revealPhone(listingId) {
    const btn = $('phone-btn');
    if (!state.currentListing?.seller?.phone) {
        btn.innerHTML = 'üìû –¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω';
        btn.disabled = true;
        return;
    }
    btn.outerHTML = `<div class="phone-reveal">üìû ${state.currentListing.seller.phone}</div>`;
}

function showMessageModal(listingId) {
    if (!state.user) { showAuthModal(); return; }
    const l = state.currentListing;
    renderModal(`
        <h2>üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥–∞–≤—Ü—É</h2>
        <p style="color:var(--text-muted);margin-bottom:16px;font-size:14px">–ü–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—é: <strong>${l.title}</strong></p>
        <div class="form-group">
            <label>–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</label>
            <textarea id="msg-text" placeholder="–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –≤–∞—à–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ...">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ï—â—ë –∞–∫—Ç—É–∞–ª—å–Ω–æ?</textarea>
        </div>
        <button class="btn btn-primary" style="width:100%;padding:13px" onclick="sendMessage(${listingId},${l.seller.id})">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    `);
}

async function sendMessage(listingId, recipientId) {
    try {
        await api('/messages/', {
            method: 'POST',
            body: JSON.stringify({
                listing: listingId,
                recipient: recipientId,
                text: $('msg-text').value,
            }),
        });
        closeModal();
        toast('‚úâÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!', 'success');
    } catch { toast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error'); }
}

// POST FORM
function renderPostForm() {
    if (!state.user) {
        app().innerHTML = `
            <div class="container page">
                <div class="empty-state">
                    <div class="emoji">üîê</div>
                    <h3>–ù—É–∂–µ–Ω –∞–∫–∫–∞—É–Ω—Ç</h3>
                    <p>–í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</p>
                    <button class="btn btn-primary" style="margin-top:16px" onclick="showAuthModal()">–í–æ–π—Ç–∏</button>
                </div>
            </div>
        `;
        return;
    }

    const cats = Array.isArray(state.categories) ? state.categories : [];
    app().innerHTML = `
        <div class="container page">
            <div class="post-form">
                <h1>üìù –ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h1>

                <div class="form-group">
                    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
                    <select id="p-category">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                        ${cats.map(c => `
                            <optgroup label="${c.icon || ''} ${c.name}">
                                ${(c.children || []).map(ch => `<option value="${ch.id}">${ch.icon || ''} ${ch.name}</option>`).join('')}
                                <option value="${c.id}">${c.icon || ''} ${c.name} (–æ–±—â–µ–µ)</option>
                            </optgroup>
                        `).join('')}
                    </select>
                </div>

                <div class="form-group">
                    <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label>
                    <input id="p-title" placeholder="–ö—Ä–∞—Ç–∫–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ, –Ω–∞–ø—Ä.: iPhone 15 Pro, 256GB, –Ω–æ–≤—ã–π">
                </div>

                <div class="form-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ *</label>
                    <textarea id="p-desc" style="height:140px" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ —Ç–æ–≤–∞—Ä: —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è, –ø—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏..."></textarea>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                    <div class="form-group">
                        <label>–¶–µ–Ω–∞ (‚ÇΩ) *</label>
                        <input id="p-price" type="number" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>–ì–æ—Ä–æ–¥</label>
                        <input id="p-city" placeholder="–ú–æ—Å–∫–≤–∞" value="${state.user?.city || ''}">
                    </div>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                    <div class="form-group">
                        <label>–°–æ—Å—Ç–æ—è–Ω–∏–µ</label>
                        <select id="p-condition">
                            <option value="used">–ë/–£</option>
                            <option value="new">–ù–æ–≤–æ–µ</option>
                            <option value="damaged">–¢—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞</option>
                        </select>
                    </div>
                    <div class="form-group" style="display:flex;align-items:center;gap:10px;padding-top:22px">
                        <input type="checkbox" id="p-negotiable" style="width:18px;height:18px;flex-shrink:0">
                        <label for="p-negotiable" style="margin:0;font-size:14px;font-weight:600;color:var(--text);cursor:pointer">–¢–æ—Ä–≥ —É–º–µ—Å—Ç–µ–Ω</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</label>
                    <div class="image-upload-area" onclick="$('p-images').click()">
                        <input type="file" id="p-images" multiple accept="image/*" onchange="previewImages(this)">
                        <div style="font-size:40px;margin-bottom:8px">üì∑</div>
                        <div style="font-weight:600;margin-bottom:4px">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</div>
                        <div style="font-size:13px;color:var(--text-muted)">–ü–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ ‚Äî –≥–ª–∞–≤–Ω–æ–µ. –ú–∞–∫—Å–∏–º—É–º 10 —Ñ–æ—Ç–æ.</div>
                    </div>
                    <div class="img-previews" id="img-previews"></div>
                </div>

                <div style="display:flex;gap:12px;margin-top:8px">
                    <button class="btn" style="border:1.5px solid var(--border);padding:13px 24px" onclick="navigate('home')">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn btn-post" style="flex:1;padding:13px;font-size:16px" onclick="submitListing()">
                        ‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
                    </button>
                </div>
            </div>
        </div>
    `;
}

function previewImages(input) {
    const container = $('img-previews');
    container.innerHTML = '';
    Array.from(input.files).slice(0, 10).forEach(file => {
        const img = document.createElement('img');
        img.className = 'img-preview';
        img.src = URL.createObjectURL(file);
        container.appendChild(img);
    });
}

async function submitListing() {
    const formData = new FormData();
    const fields = {
        title: $('p-title')?.value,
        description: $('p-desc')?.value,
        price: $('p-price')?.value,
        city: $('p-city')?.value,
        condition: $('p-condition')?.value,
        is_negotiable: $('p-negotiable')?.checked,
    };
    const catId = $('p-category')?.value;
    if (!fields.title || !fields.price) { toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error'); return; }
    if (catId) formData.append('category_id', catId);
    Object.entries(fields).forEach(([k, v]) => formData.append(k, v));
    const imgs = $('p-images')?.files;
    if (imgs) Array.from(imgs).forEach(f => formData.append('images', f));
    try {
        const listing = await api('/listings/create/', {
            method: 'POST',
            body: formData,
            headers: { Authorization: `Token ${state.token}` },
        });
        toast('üéâ –û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!', 'success');
        navigate('detail');
        loadListing(listing.id);
    } catch (e) {
        const msg = Object.values(e)[0]?.[0] || '–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏';
        toast(msg, 'error');
    }
}

// PROFILE PAGE
async function renderProfile() {
    if (!state.user) { showAuthModal(); return; }
    const u = state.user;

    app().innerHTML = `
        <div class="profile-header">
            <div class="container">
                <div class="profile-info">
                    <div class="profile-avatar">
                        ${u.avatar_url ? `<img src="${u.avatar_url}">` : getInitials((u.first_name || '') + ' ' + (u.last_name || ''))}
                    </div>
                    <div>
                        <div class="profile-name">${u.first_name || ''} ${u.last_name || u.username}</div>
                        <div class="profile-stats">
                            <div class="profile-stat">üìç ${u.city || '–ì–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
                            <div class="profile-stat">‚≠ê ${u.rating || 0} —Ä–µ–π—Ç–∏–Ω–≥</div>
                            <div class="profile-stat">–ù–∞ —Å–∞–π—Ç–µ —Å ${new Date(u.date_joined).toLocaleDateString('ru-RU', {month:'long',year:'numeric'})}</div>
                        </div>
                    </div>
                    <button class="btn btn-outline" style="margin-left:auto" onclick="doLogout()">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>

        <div class="container page">
            <div class="page-tabs">
                <div class="page-tab active" onclick="loadProfileTab('listings',this)" id="tab-listings">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</div>
                <div class="page-tab" onclick="loadProfileTab('favorites',this)" id="tab-favorites">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
                <div class="page-tab" onclick="loadProfileTab('messages',this)" id="tab-messages">–°–æ–æ–±—â–µ–Ω–∏—è</div>
                <div class="page-tab" onclick="loadProfileTab('settings',this)" id="tab-settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>
            <div id="profile-content"></div>
        </div>
    `;

    loadProfileTab('listings', $('tab-listings'));
}

async function loadProfileTab(tab, el) {
    document.querySelectorAll('.page-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    const content = $('profile-content');

    if (tab === 'listings') {
        try {
            const data = await api('/my/listings/');
            content.innerHTML = data.results?.length ? `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                    <div style="font-size:14px;color:var(--text-muted)">–û–±—ä—è–≤–ª–µ–Ω–∏–π: ${data.count || data.results.length}</div>
                    <button class="btn btn-post btn-sm" onclick="navigate('post')">+ –ù–æ–≤–æ–µ</button>
                </div>
                <div class="listings-grid">${data.results.map(l => renderCard(l)).join('')}</div>
            ` : `
                <div class="empty-state">
                    <div class="emoji">üì≠</div>
                    <h3>–ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</h3>
                    <p>–ü–æ–¥–∞–π—Ç–µ —Å–≤–æ—ë –ø–µ—Ä–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ!</p>
                    <button class="btn btn-post" style="margin-top:16px" onclick="navigate('post')">–ü–æ–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</button>
                </div>
            `;
        } catch { content.innerHTML = '<p style="color:red">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>'; }
    }

    else if (tab === 'favorites') {
        try {
            const data = await api('/my/favorites/');
            content.innerHTML = data.results?.length ? `
                <div class="listings-grid">${data.results.map(l => renderCard(l)).join('')}</div>
            ` : `
                <div class="empty-state">
                    <div class="emoji">üíî</div>
                    <h3>–ü—É—Å—Ç–æ</h3>
                    <p>–î–æ–±–∞–≤–ª—è–π—Ç–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, –Ω–∞–∂–∏–º–∞—è –Ω–∞ ‚ù§Ô∏è</p>
                </div>
            `;
        } catch { content.innerHTML = '<p>–û—à–∏–±–∫–∞</p>'; }
    }

    else if (tab === 'messages') {
        try {
            const data = await api('/my/messages/');
            content.innerHTML = data.results?.length ? `
                <div style="display:flex;flex-direction:column;gap:12px;max-width:640px">
                    ${data.results.map(m => `
                        <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;${!m.is_read?'border-left:3px solid var(--accent)':''}">
                            <div style="display:flex;justify-content:space-between;margin-bottom:6px">
                                <strong>${m.sender_name}</strong>
                                <span style="font-size:12px;color:var(--text-muted)">${timeAgo(m.created_at)}</span>
                            </div>
                            <div style="font-size:13px;color:var(--text-muted);margin-bottom:6px">–ü–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—é #${m.listing}</div>
                            <div>${m.text}</div>
                        </div>
                    `).join('')}
                </div>
            ` : `
                <div class="empty-state">
                    <div class="emoji">üí¨</div>
                    <h3>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
                </div>
            `;
        } catch { content.innerHTML = '<p>–û—à–∏–±–∫–∞</p>'; }
    }

    else if (tab === 'settings') {
        content.innerHTML = `
            <div style="max-width:480px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:24px">
                <h3 style="margin-bottom:20px">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
                    <div class="form-group"><label>–ò–º—è</label><input id="s-first" value="${state.user.first_name || ''}"></div>
                    <div class="form-group"><label>–§–∞–º–∏–ª–∏—è</label><input id="s-last" value="${state.user.last_name || ''}"></div>
                </div>
                <div class="form-group"><label>Email</label><input id="s-email" type="email" value="${state.user.email || ''}"></div>
                <div class="form-group"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="s-phone" value="${state.user.phone || ''}"></div>
                <div class="form-group"><label>–ì–æ—Ä–æ–¥</label><input id="s-city" value="${state.user.city || ''}"></div>
                <div class="form-group"><label>–û —Å–µ–±–µ</label><textarea id="s-bio">${state.user.bio || ''}</textarea></div>
                <button class="btn btn-primary" style="width:100%;padding:13px" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        `;
    }
}

async function saveProfile() {
    try {
        const formData = new FormData();
        formData.append('first_name', $('s-first').value);
        formData.append('last_name', $('s-last').value);
        formData.append('email', $('s-email').value);
        formData.append('phone', $('s-phone').value);
        formData.append('city', $('s-city').value);
        formData.append('bio', $('s-bio').value);
        state.user = await api('/auth/profile/', {
            method: 'PATCH',
            body: formData,
            headers: { Authorization: `Token ${state.token}` },
        });
        toast('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
        renderHeader();
    } catch { toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error'); }
}

// ==========================================
// MODAL
// ==========================================
function renderModal(html) {
    let backdrop = $('modal-backdrop');
    if (!backdrop) {
        backdrop = document.createElement('div');
        backdrop.id = 'modal-backdrop';
        backdrop.className = 'modal-backdrop';
        backdrop.onclick = e => { if (e.target === backdrop) closeModal(); };
        document.body.appendChild(backdrop);
    }
    backdrop.innerHTML = `
        <div class="modal">
            <button class="modal-close" onclick="closeModal()">‚úï</button>
            ${html}
        </div>
    `;
    backdrop.style.display = 'flex';
}

function closeModal() {
    const m = $('modal-backdrop');
    if (m) m.style.display = 'none';
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });


// ==========================================
// CHAT
// ==========================================

async function loadUnreadCount() {
    if (!state.user) return;
    try {
        const data = await api('/chat/unread/');
        state.unreadCount = data.unread_notifications || 0;
        state.unreadMessages = data.unread_messages || 0;
        // Update bell badge without full re-render
        const bell = $('notif-bell');
        if (bell) {
            const dot = bell.querySelector('.notif-dot');
            if (state.unreadCount > 0) {
                if (dot) dot.textContent = state.unreadCount > 9 ? '9+' : state.unreadCount;
                else bell.insertAdjacentHTML('beforeend', `<div class="notif-dot">${state.unreadCount > 9 ? '9+' : state.unreadCount}</div>`);
            } else if (dot) dot.remove();
        }
    } catch {}
}

async function toggleNotifDropdown() {
    let dropdown = $('notif-dropdown');
    if (dropdown) { dropdown.remove(); return; }
    try {
        const data = await api('/chat/notifications/');
        const notifs = Array.isArray(data) ? data : (data.results || []);
        const bell = $('notif-bell');
        const html = `
            <div id="notif-dropdown" class="notif-dropdown">
                <div class="notif-header">
                    <span>üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                    <button class="btn btn-sm" style="font-size:11px;color:var(--text-muted)" onclick="markAllNotifRead()">–ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ</button>
                </div>
                ${notifs.length === 0 ? '<div style="padding:24px;text-align:center;color:var(--text-muted)">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>' :
                    notifs.map(n => `
                        <div class="notif-item ${n.is_read ? '' : 'unread'}" onclick="openNotif(${n.dialog || 0})">
                            <div class="notif-text">${n.type === 'message' ? 'üí¨' : 'üîî'} ${n.text}</div>
                            <div class="notif-time">${timeAgo(n.created_at)}</div>
                        </div>
                    `).join('')
                }
            </div>
        `;
        bell.style.position = 'relative';
        bell.insertAdjacentHTML('afterend', html);
        // Close on outside click
        setTimeout(() => document.addEventListener('click', function handler(e) {
            if (!$('notif-dropdown')?.contains(e.target) && e.target !== bell) {
                $('notif-dropdown')?.remove();
                document.removeEventListener('click', handler);
            }
        }), 100);
    } catch {}
}

async function markAllNotifRead() {
    try {
        await api('/chat/notifications/read/', { method: 'POST' });
        state.unreadCount = 0;
        $('notif-dropdown')?.remove();
        renderHeader();
    } catch {}
}

function openNotif(dialogId) {
    $('notif-dropdown')?.remove();
    navigate('chat');
    if (dialogId) {
        setTimeout(() => openDialog(dialogId), 100);
    }
}

async function renderChat() {
    if (!state.user) { showAuthModal(); return; }

    app().innerHTML = `
        <div class="container page" style="padding-top:16px">
            <div class="chat-layout">
                <!-- Sidebar: dialogs list -->
                <div class="dialogs-sidebar">
                    <div class="dialogs-header">
                        <span>üí¨ –°–æ–æ–±—â–µ–Ω–∏—è</span>
                    </div>
                    <div class="dialogs-list" id="dialogs-list">
                        <div style="padding:24px;text-align:center;color:var(--text-muted)">
                            <div style="font-size:32px;margin-bottom:8px">‚è≥</div>
                            –ó–∞–≥—Ä—É–∑–∫–∞...
                        </div>
                    </div>
                </div>
                <!-- Chat window -->
                <div class="chat-window" id="chat-window">
                    <div class="chat-empty">
                        <div style="font-size:56px">üí¨</div>
                        <div style="font-weight:700;font-size:16px">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥</div>
                        <div style="font-size:13px">–í–∞—à–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –ø–æ—è–≤—è—Ç—Å—è —Å–ª–µ–≤–∞</div>
                    </div>
                </div>
            </div>
        </div>
    `;

    await loadDialogs();
}

async function loadDialogs() {
    try {
        const data = await api('/chat/dialogs/');
        state.dialogs = Array.isArray(data) ? data : (data.results || []);
        renderDialogsList();
    } catch { 
        const el = $('dialogs-list');
        if (el) el.innerHTML = '<div style="padding:20px;text-align:center;color:red">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
    }
}

function renderDialogsList() {
    const el = $('dialogs-list');
    if (!el) return;
    if (state.dialogs.length === 0) {
        el.innerHTML = `
            <div style="padding:32px 16px;text-align:center;color:var(--text-muted)">
                <div style="font-size:40px;margin-bottom:8px">üì≠</div>
                <div style="font-weight:600">–ù–µ—Ç –ø–µ—Ä–µ–ø–∏—Å–æ–∫</div>
                <div style="font-size:12px;margin-top:4px">–ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–æ–¥–∞–≤—Ü—É –∏–∑ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</div>
            </div>
        `;
        return;
    }
    el.innerHTML = state.dialogs.map(d => {
        const u = d.other_user;
        const last = d.last_message;
        const isActive = state.activeDialog?.id === d.id;
        return `
            <div class="dialog-item ${isActive ? 'active' : ''}" onclick="openDialog(${d.id})">
                <div class="dialog-avatar">
                    ${u.avatar_url ? `<img src="${u.avatar_url}" alt="${u.name}">` : getInitials(u.name)}
                </div>
                <div class="dialog-info">
                    <div class="dialog-name">${u.name}</div>
                    <div class="dialog-last">
                        ${last ? (last.is_mine ? '‚úì ' : '') + last.text : d.listing_title || '–ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–ø–∏—Å–∫—É'}
                    </div>
                </div>
                <div class="dialog-meta">
                    <div class="dialog-time">${last ? timeAgo(last.created_at) : ''}</div>
                    ${d.unread_count > 0 ? `<div class="unread-badge">${d.unread_count}</div>` : ''}
                </div>
            </div>
        `;
    }).join('');
}

async function openDialog(dialogId) {
    state.activeDialog = state.dialogs.find(d => d.id === dialogId);
    if (!state.activeDialog) {
        // Try loading from server
        try {
            const data = await api('/chat/dialogs/');
            state.dialogs = Array.isArray(data) ? data : (data.results || []);
            state.activeDialog = state.dialogs.find(d => d.id === dialogId);
        } catch {}
    }
    renderDialogsList(); // update active state
    renderChatWindow();
    await loadMessages(dialogId);
}

function renderChatWindow() {
    const d = state.activeDialog;
    const win = $('chat-window');
    if (!win || !d) return;
    const u = d.other_user;

    win.innerHTML = `
        <div class="chat-header">
            <div class="dialog-avatar" style="width:40px;height:40px;font-size:15px">
                ${u.avatar_url ? `<img src="${u.avatar_url}">` : getInitials(u.name)}
            </div>
            <div style="flex:1">
                <div class="chat-user-name">${u.name}</div>
                <div class="chat-user-sub">
                    ${u.phone ? `üìû ${u.phone}` : u.city ? `üìç ${u.city}` : ''}
                    ${u.rating ? ` ¬∑ ‚≠ê ${u.rating}` : ''}
                </div>
            </div>
            ${d.listing_title ? `<div style="font-size:12px;color:var(--text-muted);max-width:120px;text-align:right;line-height:1.3">–ü–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—é:<br><strong>${d.listing_title}</strong></div>` : ''}
        </div>
        <div class="chat-messages" id="chat-msgs">
            <div style="text-align:center;color:var(--text-muted);font-size:13px;padding:20px">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
        </div>
        <div id="img-strip-container"></div>
        <div class="chat-input-area">
            <div class="chat-input-wrap">
                <textarea class="chat-input" id="chat-text" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                    onkeypress="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChatMessage()}"
                    oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
                <label class="chat-attach-btn" for="chat-file-input" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ">üìé</label>
                <input type="file" id="chat-file-input" accept="image/*" multiple style="display:none" onchange="previewChatImages(this)">
            </div>
            <button class="chat-send-btn" onclick="sendChatMessage()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
        </div>
    `;
}

async function loadMessages(dialogId) {
    try {
        const data = await api(`/chat/dialogs/${dialogId}/messages/`);
        state.chatMessages = Array.isArray(data) ? data : (data.results || []);
        renderMessages();
        // Update unread count
        loadUnreadCount();
        renderDialogsList();
    } catch {}
}

function renderMessages() {
    const el = $('chat-msgs');
    if (!el) return;
    const msgs = state.chatMessages;

    if (msgs.length === 0) {
        el.innerHTML = `
            <div style="text-align:center;color:var(--text-muted);padding:40px 20px">
                <div style="font-size:40px;margin-bottom:8px">üëã</div>
                <div>–ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–ø–∏—Å–∫—É!</div>
            </div>
        `;
        return;
    }

    let html = '';
    let lastDate = '';

    msgs.forEach(msg => {
        const msgDate = new Date(msg.created_at).toLocaleDateString('ru-RU', {day:'numeric',month:'long'});
        if (msgDate !== lastDate) {
            html += `<div class="msg-date-divider">${msgDate}</div>`;
            lastDate = msgDate;
        }
        const mine = msg.is_mine;
        const avatar = msg.sender_avatar
            ? `<img src="${msg.sender_avatar}">`
            : getInitials(msg.sender_name || '?');

        html += `
            <div class="msg-row ${mine ? 'mine' : 'theirs'}">
                ${!mine ? `<div class="msg-avatar">${avatar}</div>` : ''}
                <div>
                    <div class="msg-bubble">
                        ${msg.image_url ? `<img class="msg-image" src="${msg.image_url}" onclick="window.open('${msg.image_url}','_blank')" alt="—Ñ–æ—Ç–æ">` : ''}
                        ${msg.text ? msg.text : ''}
                    </div>
                    <div class="msg-time">
                        ${new Date(msg.created_at).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'})}
                        ${mine ? (msg.is_read ? ' ‚úì‚úì' : ' ‚úì') : ''}
                    </div>
                </div>
                ${mine ? `<div class="msg-avatar">${avatar}</div>` : ''}
            </div>
        `;
    });

    el.innerHTML = html;
    el.scrollTop = el.scrollHeight;
}

function previewChatImages(input) {
    state.chatImages = Array.from(input.files);
    const container = $('img-strip-container');
    if (!container) return;
    if (state.chatImages.length === 0) { container.innerHTML = ''; return; }

    container.innerHTML = `
        <div class="img-preview-strip">
            ${state.chatImages.map((f, i) => `
                <div class="img-preview-chip">
                    <img src="${URL.createObjectURL(f)}" alt="—Ñ–æ—Ç–æ">
                    <div class="remove-img" onclick="removeChatImage(${i})">‚úï</div>
                </div>
            `).join('')}
        </div>
    `;
}

function removeChatImage(idx) {
    state.chatImages.splice(idx, 1);
    // Re-render preview
    const container = $('img-strip-container');
    if (state.chatImages.length === 0) { container.innerHTML = ''; return; }
    previewChatImages({ files: state.chatImages });
}

async function sendChatMessage() {
    if (!state.activeDialog) return;
    const text = $('chat-text')?.value?.trim() || '';
    const images = state.chatImages;

    if (!text && images.length === 0) return;

    const dialogId = state.activeDialog.id;

    // Send one request per image, then text
    try {
        if (images.length > 0) {
            for (const img of images) {
                const fd = new FormData();
                if (text) fd.append('text', text);
                fd.append('image', img);
                const msg = await apiFormData(`/chat/dialogs/${dialogId}/send/`, fd);
                state.chatMessages.push(msg);
            }
        } else {
            const fd = new FormData();
            fd.append('text', text);
            const msg = await apiFormData(`/chat/dialogs/${dialogId}/send/`, fd);
            state.chatMessages.push(msg);
        }

        // Clear inputs
        if ($('chat-text')) $('chat-text').value = '';
        state.chatImages = [];
        const container = $('img-strip-container');
        if (container) container.innerHTML = '';
        const fileInput = $('chat-file-input');
        if (fileInput) fileInput.value = '';

        renderMessages();

        // Update dialogs list
        await loadDialogs();

    } catch(e) {
        toast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
    }
}

async function apiFormData(path, formData) {
    const headers = {};
    if (state.token) headers['Authorization'] = `Token ${state.token}`;
    const res = await fetch(API + path, {
        method: 'POST',
        headers,
        body: formData,
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw data;
    return data;
}

// Start chat with seller from listing page
async function startChatWithSeller(sellerId, listingId) {
    if (!state.user) { showAuthModal(); return; }
    if (sellerId === state.user.id) { toast('–≠—Ç–æ –≤–∞—à–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ', 'error'); return; }
    try {
        const dialog = await api('/chat/dialogs/start/', {
            method: 'POST',
            body: JSON.stringify({ recipient_id: sellerId, listing_id: listingId }),
        });
        state.activeDialog = dialog;
        // Add to dialogs list if not there
        if (!state.dialogs.find(d => d.id === dialog.id)) {
            state.dialogs.unshift(dialog);
        }
        navigate('chat');
        setTimeout(() => openDialog(dialog.id), 150);
    } catch(e) {
        toast(e.error || '–û—à–∏–±–∫–∞', 'error');
    }
}

// Update last_seen every 2 minutes
setInterval(async () => {
    if (state.user) {
        try { await api('/panel/update-seen/', { method: 'POST' }); } catch {}
    }
}, 120000);

// Poll for new messages every 8 seconds when chat is open
setInterval(async () => {
    if (state.user) {
        await loadUnreadCount();
        if (state.page === 'chat' && state.activeDialog) {
            const prev = state.chatMessages.length;
            await loadMessages(state.activeDialog.id);
            // already renders
        } else if (state.page === 'chat') {
            await loadDialogs();
        }
    }
}, 8000);

// ==========================================
// INIT
// ==========================================
async function init() {
    await checkAuth();
    if (state.user) {
        await loadUnreadCount();
        try { await api('/panel/update-seen/', { method: 'POST' }); } catch {}
    }
    renderHeader();
    await loadCategories();
    await loadListings();
    renderHome();
}

init();
</script>
</body>
</html>
